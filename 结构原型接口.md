好的，我将补充以下内容：

1. **架构设计图**：绘制完整的系统架构示意图，涵盖前端、后端、任务调度、知识管理、工具管理等模块。
2. **页面原型图与交互设计稿**：提供主要页面的布局原型，包括任务管理、工具管理、SOP管理等界面。
3. **API接口详细定义文档**：补充任务管理、工具管理、权限控制、知识管理等核心API的详细说明，包括请求/响应格式、参数、示例等。

我将整理这些内容并补充到文档中，完成后与你分享！

### 1. 架构设计图

李府管家系统采用前后端分离的分层架构，整体由**前端、代理层、后端、任务调度、知识管理、工具管理和存储系统**等模块组成，各模块职责清晰、解耦互通：

- **前端（React + TailwindCSS）**：使用React构建单页应用，结合TailwindCSS进行样式设计，实现丰富的交互界面。前端主要提供用户界面，包括任务管理、工具管理、知识库检索、SOP执行、权限管理等页面，与后端通过API进行通信。
- **代理层（Nginx）**：采用Nginx作为反向代理服务器。一方面由Nginx托管前端静态资源（HTML、CSS、JS），向用户提供网页访问；另一方面将特定路径下的API请求转发给后端FastAPI服务。Nginx提高了系统的安全性和并发能力，可实现负载均衡、静态文件缓存，以及对外统一的入口。
- **后端（FastAPI）**：后端核心采用FastAPI框架提供RESTful API服务，处理业务逻辑。FastAPI负责验证请求、调用内部模块（如任务处理、知识检索、权限校验等），并返回JSON响应。其高性能异步特性确保即使高并发访问也能快速响应。此外通过OAuth2实现认证，基于RBAC模型进行权限控制，保护敏感接口。大部分业务功能（任务创建、工具调用、知识库查询、SOP流程控制等）均由FastAPI提供API接口。
- **任务调度（Celery）**：对于耗时或需要异步执行的任务，系统采用Celery作为任务队列实现异步调度。FastAPI在接收到需要后台处理的请求时，将任务推送到Celery队列中。Celery Worker进程监听任务队列，获取任务后异步执行实际的工作逻辑（例如复杂的SOP流程、外部工具调用、AI推理等），执行完毕后将结果保存。这样可以避免阻塞FastAPI主进程，提高系统吞吐量。Celery还可配合Celery Beat实现定时任务调度，用于周期性工作。
- **知识管理（Redis + Faiss）**：知识管理模块提供智能Agent的记忆和知识检索能力。短期记忆利用高速缓存数据库Redis存储（例如会话的临时数据、最近的对话上下文），方便快速读写和过期管理；长期知识则通过向量索引库Faiss进行管理，将文档或知识点嵌入向量后存储索引，提供相似度检索功能。当需要知识检索时，后端会调用Faiss检索最相关的向量以获取知识。Redis在此也可用作Faiss检索的辅助缓存，加速重复查询。该模块使管家系统具有“记忆力”，能在任务执行过程中查询业务知识库或上下文记录。
- **工具管理（FastAPI + OAuth2 + RBAC）**：工具管理模块负责对接和管控系统可用的各种第三方工具或内部功能模块。例如外部API服务、企业内部系统接口等。通过FastAPI子模块提供工具注册、工具调用和审批等接口。引入OAuth2机制对接外部工具的认证，RBAC模型限制不同角色对工具的访问权限（如某些工具需要管理员审批后才能使用）。工具管理模块统一登记可用工具（名称、接口端点、所需权限等），记录每次工具调用日志，以备审计和故障排查。
- **存储系统**：包括关系型数据库PostgreSQL、内存数据库Redis和对象存储MinIO等多种存储介质。
  - *PostgreSQL*: 作为系统的主要持久化存储，保存业务核心数据，如用户账户、角色权限、任务信息、SOP模板、工具登记信息等，保证数据可靠性和支持复杂查询。
  - *Redis*: 在本系统中扮演多重角色，既是Celery的消息队列和结果存储（Broker/Backend）、短期数据缓存，也是会话状态或临时计算结果的存储，加速读写访问。此外利用Redis的发布/订阅或过期机制，可以实现任务状态的实时通知等功能。
  - *MinIO*: 以对象存储方式保存非结构化数据和大文件，如任务相关的附件、知识库中的文档资料、多媒体文件等。FastAPI后端通过MinIO SDK进行文件的上传下载，保障文件存储的可靠性和可扩展性。MinIO兼容S3协议，方便将来迁移或与云存储对接。

各组件之间通过明确的接口协议通信：前端通过HTTPS请求调用后端FastAPI API；FastAPI内部通过Celery将任务发往Redis队列，由Celery Worker异步消费执行；FastAPI直接读写PostgreSQL获取业务数据，或访问Redis获取缓存数据；需要文件时读取MinIO；进行知识查询时调用Faiss库接口；调用外部工具则通过工具管理模块集中处理。Nginx保证了这些内部服务对外表现为统一域名下的服务。整个架构具有**高内聚低耦合、易扩展、高并发**的特点。

（*架构示意图*：如下图所示，用户通过浏览器访问前端React应用，Nginx将请求分别转发至前端静态资源或后端API。后端FastAPI处理请求业务逻辑，并与数据库、缓存、对象存储交互。如果遇到耗时任务则提交给Celery异步处理。FastAPI也负责知识检索调用Faiss、通过工具管理访问外部服务等。各模块共同协作完成李府管家系统的功能。） 

> **注**：由于文字环境限制，此处省略架构图的图片描述。架构图应展示各模块（前端、Nginx、FastAPI、Celery、Redis、PostgreSQL、MinIO、Faiss、工具管理）之间的连接关系和数据流。

### 2. 页面原型图与交互设计稿

李府管家系统包含多个功能模块，对应不同的管理页面。下面提供主要页面的原型草图和交互设计要点：

#### 任务管理页面

任务管理模块用于创建和跟踪各类任务，包括展示任务列表、查看任务详情、管理任务流程等。

- **任务列表页面**：以列表或看板方式展示当前所有任务的概览，包括任务名称、描述、状态、负责人、优先级等字段，可支持按状态分类（待办、进行中、已完成）。页面提供“新建任务”按钮用于创建新任务，并支持筛选和搜索功能。每条任务摘要显示其重要属性，一目了然。

*任务管理-任务列表原型*：该原型展示了项目“Craftboard Project”下任务的列表视图。按状态分类显示“待办(To-do)”、“进行中(On Progress)”、“审核中(In Review)”等分组，每个任务条目包含名称、描述、截止日期、类型、负责人缩写头像、优先级标签等，使管理员可以直观了解各任务进度【24†look】。右上方提供筛选(Filter)和新建任务(New Task)入口。

- **任务详情页面**：点击任务列表中的某一任务，可进入任务详情查看页面。这里展示任务的完整信息：状态、优先级、负责人、相关标签、描述说明、附件列表、子任务列表、评论讨论、活动日志等。任务详情支持实时更新和编辑，例如修改状态（开始、暂停、完成）、添加备注等。设计上通常采用侧边弹出面板或独立页面展示详情。

*任务管理-任务详情原型*：图中右侧面板显示了选中任务“KPI and Employee Statistics Page”的详情，包括状态（On Progress）、截止日期、负责人(Assignee)、标签、描述说明，以及附件(Attachments)和子任务(Subtasks)等信息【59†look】。用户可以在“Subtasks”子模块下看到该任务的步骤进展，在“Comments”中查看讨论，在“Activities”中查看历史记录。左侧仍保留任务看板，方便对比查看多个任务。

- **任务创建页面**：点击“新建任务”进入任务创建表单原型。表单包括输入任务标题、描述、选择负责人、设定截止日期、优先级、关联标签、所属项目或分类等字段。表单交互设计应简洁明了，必要项清晰标注，支持上传附件或添加子任务模板。创建后点保存，由后端生成新任务并刷新列表。

- **任务监控/执行状态**：在任务详情或列表中，通过UI元素直观呈现任务当前的执行状态和进度。例如进行中的任务显示进度条或状态标签，已完成任务以绿色对勾标识，异常/失败任务则高亮提示。Dashboard也会汇总任务状态统计（见下）。

#### 工具管理页面

工具管理模块供管理员注册新的“工具”以及监控工具的使用情况，包括工具列表、工具详情、调用记录和权限审批界面等。

- **工具注册页面**：提供一个表单原型，用于登记新的工具。例如输入工具名称、工具类型（API接口/脚本）、工具描述、以及对接配置（如调用URL、鉴权信息）等。支持为工具指定所需权限角色或审批流程（如某些敏感工具仅管理员角色可调用）。提交后工具入库保存。

- **工具列表页面**：展示所有已注册工具的清单。每行包含工具名称、类别、状态（可用/下线）、最近调用时间、调用次数等摘要信息。管理员可以启用/停用某个工具，或者点击查看详情。列表支持按类别或状态筛选。

- **工具详情与调用记录**：点选某个具体工具进入详情页面，显示工具的完整信息（注册信息、配置详情、权限要求等）。下方是**调用记录**子板块，列出最近该工具的使用日志——包括调用时间、调用者用户、请求参数、调用结果（成功/失败）及耗时等，方便管理员审核追溯。若某些调用需要审批，管理员在此界面可以审批或拒绝，并填写备注。

- **权限审批页面**：当普通用户请求使用某工具而其权限不足时，会触发审批流程。管理员可以在审批列表页面看到待审批的工具调用请求，每条包含申请人、工具名称、申请理由、申请时间等。交互上提供同意或拒绝按钮，方便一键处理。审批完成后申请人会收到通知。

工具管理页面的交互应确保安全性，例如在注册/编辑工具时要求管理员身份，审批操作提供二次确认等。

#### 知识管理页面

知识管理模块包括知识库内容的检索，以及AI智能体的短期/长期记忆查看等界面：

- **知识库检索页面**：提供全局的知识搜索功能，允许用户输入关键词查询知识库中文档或条目。原型设计一个搜索栏，下面显示搜索结果列表。每个结果项显示标题、摘要片段、相关度评分等。用户点击结果可查看知识的详细内容（例如知识文章全文、文件预览等）。若知识条目有分类或标签，也可在侧边栏进行筛选。

- **短期记忆查看**：短期记忆一般用于展示AI助手最近一次对话或操作的上下文。在原型中，可以在知识管理或对话界面侧栏提供“短期记忆”查看窗口，列出最近N条交互内容。例如最近的用户提问和AI回答列表，或最近操作过的任务摘要，使管理员了解AI当前上下文。短期记忆区通常较小，只保存有限的条目，并允许清除或保存为长期记忆的操作按钮。

- **长期记忆管理**：长期记忆对应系统积累的知识点。页面可能以列表或树状结构展示长期记忆条目（类似知识库条目），每条包含关键内容摘要和创建时间等。管理员可以选择某些短期记忆条目一键保存到长期知识库（即“保存为知识”功能），或删除过期的知识。长期记忆页面也应提供基本的增删改功能，比如编辑知识条目内容、上传新的知识文档等接口。

**交互设计**：知识检索结果页面在用户输入关键字时动态提供搜索建议或自动完成；检索结果高亮关键词。对于记忆查看页面，当AI执行新任务或对话更新时，该页面内容同步刷新，以反映最新短期记忆。长期知识库管理则注重分类和版本管理，例如支持按主题查看知识条目、最近更新提示等，以方便知识维护。

#### SOP管理页面

SOP（Standard Operating Procedure，标准操作流程）管理模块让管理员创建标准流程模板并监督流程执行：

- **创建SOP模板页面**：原型提供一个流程编辑界面，用于定义新的SOP模板。一般采用**表单 + 流程节点设计器**的形式。表单填写SOP名称、适用场景、描述说明等；下面是流程步骤编辑区域，可按顺序添加多个步骤。每个步骤可以包含执行的动作（例如调用某工具API、等待人工输入、分支判断等）、负责人角色、超时时间等配置。交互设计上，可采用可视化流程图或节点列表让用户直观排列步骤顺序。用户可拖拽调整步骤顺序，设置分支条件。编辑完成后保存模板供后续使用。

- **SOP模板列表页面**：展示所有已创建的SOP模板，列表包含模板名称、版本号、创建人、更新时间等。支持点击某模板查看详情或编辑，支持创建新模板和删除废弃模板的操作。列表项上可能直接提供“一键执行”按钮，方便快速启动该流程。

- **SOP执行流程页面**：当用户启动某个SOP后，进入流程执行监控页面。该页面按照模板定义的步骤顺序，实时展示流程执行进度。每个步骤以模块卡片形式显示：步骤名称、状态（未开始/进行中/完成/出错）、开始时间、结束时间或耗时等。如果流程中有人工决策点，界面在该步骤提供操作入口（如“批准”或“输入结果”按钮）。整个流程执行完毕后，页面会总结各步骤结果并给出流程完成状态。管理员可以在此页面中途终止流程或重试失败步骤。交互关键在于**实时更新**：通过前端轮询或WebSocket推送，在界面上动态更新步骤状态（例如某一步完成时高亮并标记为完成，自动开始下一步计时）。

- **历史流程实例页面**：SOP管理也包含对已执行过的流程实例的查询页面。以列表形式显示所有执行过的流程记录，包括执行的模板名、启动时间、发起人、执行结果（成功/失败）等。点击某条记录可查看该实例的详细执行经过（各步骤的结果数据、错误日志等），便于日后审计和分析改进。

#### 用户权限管理页面

用户和权限管理提供对系统用户账户、角色以及权限策略的配置界面：

- **用户管理页面**：列出现有系统用户账户列表，包含用户名、姓名、所属角色、账户状态（启用/禁用）等。管理员可以在此添加新用户或编辑已有用户的信息。添加用户时填写用户名、初始密码、选择角色等；编辑用户可重置密码、修改角色、禁用账户等。原型中应有明确的操作按钮，例如“新增用户”、“编辑”、“删除”等，每个用户行也可有启用/停用开关。支持按角色或姓名搜索用户。

- **角色管理页面**：列出系统中定义的角色，如“管理员”、“普通用户”、“访客”等。每个角色行展示角色名称和简要描述、拥有的权限数量或范围。点击某角色可查看其详细权限配置，包括具体可访问的模块或API列表。管理员可以新建角色，或调整角色的权限。原型可设计为角色-权限的双栏界面：左侧选中某角色，右侧显示权限复选列表，可勾选该角色拥有的功能权限。提交后保存更新。

- **权限分配页面**（可选，或集成在用户编辑页面）：用于将角色赋予给用户。若在用户编辑时直接选角色即可，此处可不单独设计页面。但若权限模型较复杂，也可以有专门界面：左侧选用户，右侧多选其所属角色（支持一个用户多角色），或按部门批量赋权等。

*用户权限管理原型*：此原型展示了一个给新用户分配角色和权限的流程。左侧是“添加新用户(Add new user)”分步向导，第2步列出可选择的职位/角色列表（如Administrator管理员、Permissions Supervisor权限主管等）【37†look】。中间面板“Add new permissions”列出针对所选角色可授予的具体权限项（以开关形式开启某些功能权限）。右侧面板汇总了“Requests supervisor”角色当前已有的权限和额外可选权限。通过这种交互，管理员可以方便地为用户勾选赋予不同角色及细粒度权限。

- **认证设置页面**（OAuth2配置）：显示OAuth2客户端设置，如Token有效期、刷新策略等，以及第三方登录方式配置（如果有）。管理员可在此页面更新认证策略，例如密码策略（密码复杂度要求、过期时间）等，以加强安全。

用户权限管理界面应注重操作的**确认和反馈**：比如删除用户、删除角色前弹出确认框；修改权限后提示更新成功。界面布局需清晰区分用户列表和权限列表，避免误操作。

#### Dashboard 仪表盘

仪表盘汇总展示系统的关键运行指标和状态概览，是管理员进入系统后的首页概览页面。Dashboard通过图表、统计卡片等方式直观呈现系统实时数据：

- **任务统计板块**：显示当前任务的整体情况统计。如各状态任务数量（待办/进行中/已完成/异常的任务数饼图或柱状图）、今日新建任务数、本周完成任务数、逾期任务数等关键指标。可能使用彩色图表（如圆环图显示不同状态任务占比，折线图显示每日任务完成趋势）。

- **执行状态板块**：展示Celery任务队列和系统运行的状态信息。例如当前任务队列长度、Worker节点数、平均任务处理时长等。此外可显示近期执行的几个任务及其状态（成功/失败），失败任务条目突出警示并提供链接查看详情。还可以展示系统资源占用（CPU/内存）等，帮助判断性能瓶颈。

- **工具使用情况**：统计各工具被调用次数排名，近期失败率等。如果某些工具发生错误次数较多，仪表盘中给予提醒。

- **用户活动**：显示最近用户登录活动、活跃用户数，或未处理的权限申请数量等提醒。

- **知识库/SOP摘要**：例如知识库条目总数，今日新增知识数；进行中的SOP流程数量，成功率等。

通过仪表盘，管理员可以一眼获知系统健康状况和主要业务指标。交互设计上，Dashboard通常以多个**卡片**或**网格块**布局，各板块的信息相对独立。关键数字用大号字体展示，搭配简短文字说明；图表需配色清晰易读，并提供图例。若某些指标需要看详情，可在卡片右上角提供“查看详细”链接跳转到相应模块的管理页面。

*Dashboard 仪表盘原型*：图示为一个财务数据仪表盘示例，其中包含总余额、利润统计以及各种资产占比的图表【47†look】。李府管家系统的Dashboard可参考类似设计，将任务和系统指标通过卡片+图表的方式展现。如左侧圆环图显示任务按状态占比，右侧折线图显示任务完成趋势，中间以卡片显示关键指标数字等，使管理员对系统运行状态了然于心。

### 3. API接口详细定义文档

以下是李府管家系统各主要功能模块的API接口规范定义。每个接口包含请求方法、URL路径、请求参数、返回结果示例以及可能的错误码说明。

#### 任务管理 API

任务管理相关的主要接口包括创建任务、查询任务状态和取消任务等：

- **创建任务**（Create Task）  
  - **请求方法**：POST  
  - **接口路径**：`/api/tasks`  
  - **请求参数**（JSON）：  
    - `title` (string)：任务标题，必填，如`"编写周报"`.  
    - `description` (string)：任务详细描述，选填。  
    - `assignee_id` (integer)：任务负责人用户ID，必填。  
    - `due_date` (string)：截止日期，ISO日期格式，如`"2025-03-20"`.  
    - `priority` (string)：优先级，可选值如`"高"`/`"中"`/`"低"`.  
    - `tags` (array[string])：任务标签列表，可选。  
    - `project_id` (integer)：所属项目ID，可选，用于分类任务。  
  - **返回结果**（JSON示例）：  
    ```json
    {
      "task_id": 123,
      "title": "编写周报",
      "status": "pending",
      "assignee": {"id": 5, "name": "张三"},
      "priority": "中",
      "due_date": "2025-03-20",
      "message": "Task created successfully"
    }
    ```  
    返回新建任务的唯一ID和主要信息，初始状态为`pending`（待处理）。
  - **错误码**：  
    - 400 Bad Request：请求参数缺失或格式错误，例如缺少标题或负责人ID。  
    - 401 Unauthorized：未提供有效的认证凭证（未登录）。  
    - 403 Forbidden：当前用户无权创建任务（权限不足）。  

- **获取任务状态**（Get Task Status）  
  - **请求方法**：GET  
  - **接口路径**：`/api/tasks/{task_id}`  
  - **路径参数**：`task_id`为任务ID，如`/api/tasks/123`。  
  - **请求参数**：无（在URL路径中提供任务ID）。  
  - **返回结果**（JSON示例）：  
    ```json
    {
      "task_id": 123,
      "title": "编写周报",
      "status": "in_progress",
      "assignee": {"id": 5, "name": "张三"},
      "progress": 50,
      "result": null
    }
    ```  
    字段说明：`status`表示当前状态（如`pending`待处理，`in_progress`进行中，`completed`已完成，`failed`失败等），`progress`为进度百分比（如有），`result`在任务完成后包含任务结果数据（未完成则为null）。
  - **错误码**：  
    - 404 Not Found：指定的任务ID不存在。  
    - 401 Unauthorized：未授权访问。  
    - 403 Forbidden：无权查看该任务（非任务相关人员但尝试访问受限任务）。  

- **取消任务**（Cancel Task）  
  - **请求方法**：POST / DELETE （两种设计任选其一，下述以POST为例）  
  - **接口路径**：`/api/tasks/{task_id}/cancel`  
  - **路径参数**：`task_id`为要取消的任务ID。  
  - **请求参数**：可以无主体，或需要时提供取消原因：  
    ```json
    { "reason": "不再需要执行该任务" }
    ```  
  - **返回结果**（JSON示例）：  
    ```json
    {
      "task_id": 123,
      "status": "canceled",
      "message": "Task has been canceled"
    }
    ```  
    若任务已成功取消，返回其状态更新为`canceled`，并给出确认消息。对于已经执行完毕或无法取消的任务，则返回相应信息。
  - **错误码**：  
    - 400 Bad Request：任务已完成或无法取消（比如已经取消或状态不允许）。  
    - 404 Not Found：任务ID不存在。  
    - 401/403：未授权或无权限取消该任务（例如非管理员试图取消他人任务）。  

*(此外，任务管理API可能还包括任务列表查询（GET `/api/tasks` 支持过滤分页）、更新任务( PUT/PATCH `/api/tasks/{id}` 修改描述等)、添加子任务、上传附件等接口，此处从略).* 

#### 工具管理 API

工具管理提供注册新工具、调用工具以及查询工具状态/调用结果的接口：

- **注册工具**（Register Tool）  
  - **请求方法**：POST  
  - **接口路径**：`/api/tools`  
  - **请求参数**（JSON）：  
    - `name` (string)：工具名称，必填，如`"CRM系统接口"`.  
    - `type` (string)：工具类型，例如`"api"`或`"script"`等。  
    - `endpoint` (string)：工具调用的URL或执行入口，例如`"https://api.example.com/xxx"`（当type为api时）或脚本名称（当type为script时）。  
    - `description` (string)：工具描述，选填。  
    - `auth_type` (string)：认证方式，例如`"apiKey"`/`"OAuth2"`/`"None"`等，选填。  
    - `auth_info` (object)：认证所需信息，根据auth_type不同如存放API Key值、OAuth2客户端ID等，选填。  
    - `required_role` (string)：使用该工具所需最低角色，如`"admin"`，选填。  
  - **返回结果**（JSON示例）：  
    ```json
    {
      "tool_id": 7,
      "name": "CRM系统接口",
      "status": "active",
      "message": "Tool registered successfully"
    }
    ```  
    返回新工具的ID，以及当前状态（默认`active`启用）。 
  - **错误码**：  
    - 400 Bad Request：参数不合法，如名称重复、endpoint格式不正确等。  
    - 401 Unauthorized / 403 Forbidden：未认证或无权限进行工具注册（需要管理员角色）。  

- **调用工具**（Invoke Tool）  
  - **请求方法**：POST  
  - **接口路径**：`/api/tools/{tool_id}/invoke`  
  - **路径参数**：`tool_id`为要调用的工具ID。  
  - **请求参数**（JSON）：根据具体工具要求传递所需的输入参数。例如，对于API类工具，可能需要提供请求payload；对于脚本类工具，则提供输入参数。格式例如：  
    ```json
    {
      "params": {
        "customer_id": 12345,
        "date": "2025-03-15"
      }
    }
    ```  
    *（通用设计下，将所有调用所需参数封装在`params`对象中，也可以根据不同工具类型拆分不同字段）*  
  - **返回结果**（JSON示例）：  
    ```json
    {
      "invoke_id": "abc123def", 
      "tool_id": 7,
      "status": "running",
      "message": "Tool invocation accepted, processing"
    }
    ```  
    调用工具通常是异步操作。后端接收请求后，立即返回一个调用ID（invoke_id）用于追踪此次调用状态，初始状态为`running`或`pending`。服务器会在后台实际调用对应工具。 
  - **错误码**：  
    - 404 Not Found：工具ID不存在或工具已停用。  
    - 400 Bad Request：请求参数不足或格式错误（如必须的params缺失）。  
    - 401/403：未授权或用户无权调用该工具（例如权限不够需要审批）。  
    - 423 Locked：工具当前不可用（可能正在维护或被锁定）。  

- **获取工具调用状态**（Get Tool Invocation Status）  
  - **请求方法**：GET  
  - **接口路径**：`/api/tools/invocations/{invoke_id}`  
  - **路径参数**：`invoke_id`为调用请求ID，即调用工具时返回的ID。  
  - **请求参数**：无。  
  - **返回结果**（JSON示例）：  
    ```json
    {
      "invoke_id": "abc123def",
      "tool_id": 7,
      "status": "success",
      "output": {
        "resultCode": 0,
        "resultData": { "customerName": "张三", "balance": 5000 }
      },
      "finished_at": "2025-03-15T21:35:00Z"
    }
    ```  
    当调用完成时，`status`会变为`success`或`failed`，并在`output`中给出返回结果或错误信息。`finished_at`是完成时间戳。若仍在执行则status可能是`running`且无output。  
  - **错误码**：  
    - 404 Not Found：无效的调用ID（可能ID错误或已经过期删除）。  
    - 401 Unauthorized：未认证。  
    - 403 Forbidden：无权查询该调用结果（若调用涉及敏感数据且查询人非发起者）。  

*(补充：工具管理API可能还包括获取工具列表(GET `/api/tools`)，更新工具( PUT `/api/tools/{id}` )，启用/禁用工具( POST `/api/tools/{id}/{activate|deactivate}` )，获取工具调用日志(GET `/api/tools/{id}/logs`)等。这里聚焦主要功能。)*

#### 权限控制 API

权限控制模块涵盖用户认证（OAuth2获取令牌）和基于RBAC的权限管理接口：

- **用户登录获取Token**（OAuth2 Password模式示例）  
  - **请求方法**：POST  
  - **接口路径**：`/api/auth/token`  
  - **请求参数**：使用表单格式或JSON，包含用户名和密码凭证：  
    - `username` (string)：用户名。  
    - `password` (string)：密码。  
    *（若采用OAuth2的密码授权模式，可按RFC规范使用`grant_type=password`等字段，这里简化描述）*  
  - **返回结果**（JSON示例）：  
    ```json
    {
      "access_token": "eyJhbGciOiJIUzI1NiIs...",
      "token_type": "Bearer",
      "expires_in": 3600,
      "refresh_token": "8xLOxBtZp8",
      "scope": "read write"
    }
    ```  
    返回JWT格式的访问令牌(`access_token`)，令牌类型，一般为Bearer，还有有效期秒数，以及可选的刷新令牌和授权范围。客户端随后在调用其他受保护API时需在HTTP头加入`Authorization: Bearer {access_token}`。  
  - **错误码**：  
    - 400 Bad Request：请求参数不完整（缺用户名或密码）。  
    - 401 Unauthorized：认证失败，用户名或密码错误。  
    - 423 Locked：账户被锁定或禁用，无法获取令牌。  

- **获取当前用户信息**（用于验证Token）  
  - **请求方法**：GET  
  - **接口路径**：`/api/auth/me`  
  - **请求头**：需要`Authorization: Bearer {token}`附带有效令牌。  
  - **请求参数**：无。  
  - **返回结果**（JSON示例）：  
    ```json
    {
      "user_id": 5,
      "username": "zhangsan",
      "roles": ["admin", "editor"],
      "permissions": ["task:create", "task:view", "tool:invoke", "..."]
    }
    ```  
    返回当前登录用户的基本信息，包括角色列表和具体权限列表（权限列表通常由后端根据其角色展开）。  
  - **错误码**：  
    - 401 Unauthorized：未提供令牌或令牌无效/过期。  

- **获取用户列表**（User Management - 需管理员权限）  
  - **请求方法**：GET  
  - **接口路径**：`/api/users`  
  - **请求参数**：支持查询参数过滤：如`?role=admin`按角色筛选，`?q=关键词`按用户名/姓名搜索，`?page=1&size=20`分页等。  
  - **返回结果**（JSON示例）：  
    ```json
    {
      "total": 42,
      "page": 1,
      "size": 20,
      "users": [
        { "id": 1, "username": "admin", "roles": ["admin"], "status": "active" },
        { "id": 5, "username": "zhangsan", "roles": ["editor"], "status": "active" },
        ...
      ]
    }
    ```  
    返回用户总数以及当前页的用户列表，每个用户包含主要信息和状态。  
  - **错误码**：  
    - 403 Forbidden：当前用户无权查看用户列表（需管理员角色）。  
    - 401 Unauthorized：未认证。  

- **创建新用户**（需管理员权限）  
  - **请求方法**：POST  
  - **接口路径**：`/api/users`  
  - **请求参数**（JSON）：  
    - `username` (string)：新用户登录名，必填。  
    - `password` (string)：初始密码，必填。  
    - `roles` (array[string])：授予的角色列表，如`["editor","viewer"]`，必填至少一个角色。  
    - `full_name` (string)：姓名，选填。  
    - `email` (string)：邮箱，选填。  
  - **返回结果**（JSON示例）：  
    ```json
    {
      "id": 43,
      "username": "lisi",
      "roles": ["viewer"],
      "status": "active",
      "message": "User created successfully"
    }
    ```  
    新用户初始状态为active（启用）。  
  - **错误码**：  
    - 400 Bad Request：用户名已存在或参数格式不合法（密码太短等）。  
    - 403 Forbidden：无权执行此操作（非管理员）。  
    - 401 Unauthorized：未认证。  

- **更新用户角色**（分配/调整角色）  
  - **请求方法**：PUT/PATCH  
  - **接口路径**：`/api/users/{id}/roles`  
  - **请求参数**（JSON）：  
    - `roles` (array[string])：新的角色列表。  
  - **返回结果**：更新后的用户角色信息或成功消息。  
  - **错误码**：  
    - 400：参数错误（如角色名称无效）。  
    - 403：无权限。  
    - 404：用户不存在。  

- **获取角色列表**  
  - **请求方法**：GET  
  - **接口路径**：`/api/roles`  
  - **返回结果**（JSON示例）：  
    ```json
    {
      "roles": [
        { "name": "admin", "description": "管理员", "permissions": ["*"] },
        { "name": "editor", "description": "编辑人员", "permissions": ["task:create","task:edit","tool:invoke"] },
        ...
      ]
    }
    ```  
    列出系统所有角色及其拥有的权限（`"*"`表示拥有所有权限）。  
  - **错误码**：无特别错误，常见认证/权限错误码同上。

*(权限控制API还可能包括：刷新令牌接口POST `/api/auth/refresh`、登出接口POST `/api/auth/logout`（作令牌失效处理）、删除用户DELETE `/api/users/{id}`、删除角色DELETE `/api/roles/{name}`等。)*

#### 知识管理 API

知识管理模块提供短期记忆、长期记忆的存取和知识库搜索等接口：

- **短期记忆存储**（Store Short-term Memory）  
  *（短期记忆通常和会话或任务关联，这里假设以任务ID关联）*  
  - **请求方法**：POST  
  - **接口路径**：`/api/memory/short-term`  
  - **请求参数**（JSON）：  
    - `task_id` (integer)：关联的任务或会话ID，必填。  
    - `content` (string)：需要存储的记忆内容，必填，例如一段对话文本或最近状态描述。  
  - **返回结果**（JSON示例）：  
    ```json
    { "message": "Memory stored", "task_id": 101, "memory_id": "5f8c" }
    ```  
    返回存储成功消息以及产生的记忆条目ID（如有）。短期记忆通常保存在Redis，memory_id可用于调试或特殊查询。  
  - **错误码**：  
    - 400 Bad Request：参数缺失。  
    - 401 Unauthorized：未认证。  
    - 404 Not Found：task_id对应的任务不存在。  

- **获取短期记忆**（Get Short-term Memory）  
  - **请求方法**：GET  
  - **接口路径**：`/api/memory/short-term`  
  - **请求参数**：支持查询参数指定范围：  
    - `task_id` (integer)：指定任务ID，获取该任务关联的短期记忆内容。  
    - `limit` (integer)：可选，限制返回最近多少条记忆，默认为全部。  
  - **返回结果**（JSON示例）：  
    ```json
    {
      "task_id": 101,
      "memories": [
        { "timestamp": "2025-03-15T21:30:00Z", "content": "用户请求: 查询库存" },
        { "timestamp": "2025-03-15T21:30:05Z", "content": "助手应答: 库存为100件" }
      ]
    }
    ```  
    返回按时间顺序的记忆列表内容。短期记忆条目通常包含时间戳和内容。  
  - **错误码**：  
    - 404 Not Found：任务不存在或该任务无短期记忆。  
    - 401 Unauthorized / 403 Forbidden：无权访问该任务记忆。  

- **长期记忆创建/更新**（Add to Knowledge Base）  
  - **请求方法**：POST  
  - **接口路径**：`/api/knowledge`  
  - **请求参数**（JSON）：  
    - `title` (string)：知识条目标题，必填。  
    - `content` (string)：知识正文内容，必填（可为文本或可解析的文档内容）。  
    - `tags` (array[string])：标签分类，选填。  
    - `source` (string)：知识来源说明，如`"用户反馈整理"`，选填。  
  - **返回结果**（JSON示例）：  
    ```json
    { "knowledge_id": 88, "message": "Knowledge entry saved" }
    ```  
    保存成功返回新知识条目ID。系统将在后台对content生成向量嵌入并更新Faiss索引。  
  - **错误码**：  
    - 400：参数不完整。  
    - 401/403：未授权或无权限添加知识（可能仅特定角色能维护知识库）。  

- **知识库检索**（Knowledge Search）  
  - **请求方法**：GET  
  - **接口路径**：`/api/knowledge/search`  
  - **请求参数**：  
    - `query` (string)：搜索关键词或问句，必填，支持自然语言查询。  
    - `top_k` (integer)：可选，返回相关度最高的前K条结果，默认例如5条。  
  - **返回结果**（JSON示例）：  
    ```json
    {
      "query": "库存不足怎么办",
      "results": [
        { "knowledge_id": 12, "title": "库存管理流程", "snippet": "当库存不足时，可通过以下步骤...", "score": 0.95 },
        { "knowledge_id": 7, "title": "缺货处理方案", "snippet": "对于缺货，建议联系供应商...", "score": 0.89 }
      ]
    }
    ```  
    返回匹配查询的知识条目列表，每项包含知识ID、标题、内容摘要片段（snippet）和相关度评分。前端可根据ID提供链接查看完整内容。  
  - **错误码**：  
    - 400 Bad Request：缺少query参数。  

- **获取知识条目详情**  
  - **请求方法**：GET  
  - **接口路径**：`/api/knowledge/{knowledge_id}`  
  - **返回结果**：包含知识完整内容、标题、标签等详细信息。  
  - **错误码**：404条目不存在等。

*(说明：短期记忆更多是内部机制，有时可能不单独提供开放API，仅供AI Agent内部使用。但为方便管理和调试，这里假设提供简单API接口。长期记忆即知识库，可以通过通用知识接口来增删改查。)*

#### SOP管理 API

SOP管理涉及SOP模板的增删改查，以及SOP流程实例的启动与跟踪接口：

- **创建SOP模板**（Create SOP Template）  
  - **请求方法**：POST  
  - **接口路径**：`/api/sop/templates`  
  - **请求参数**（JSON）：  
    - `name` (string)：模板名称，必填。  
    - `description` (string)：模板说明，选填。  
    - `steps` (array[object])：步骤列表，必填。每个步骤对象包含：  
      - `order` (integer)：步骤顺序序号。  
      - `name` (string)：步骤名称/标识。  
      - `action` (string)：步骤的执行动作类型，如`"invoke_tool"`或`"manual_approval"`等。  
      - `params` (object)：执行该步骤所需参数，根据action不同，如调用工具时包含`tool_id`及调用参数映射。  
      - `assignee_role` (string)：该步骤负责人角色（如果需要人工处理），如`"manager"`，选填。  
      - `timeout` (integer)：超时时间（秒），选填。  
      - ...（其他如条件分支等可扩展字段）  
    - `version` (string)：版本号，选填，不提供则系统默认生成如`"1.0"`。  
  - **返回结果**（JSON示例）：  
    ```json
    {
      "template_id": 5,
      "name": "库存检查流程",
      "steps_count": 3,
      "message": "SOP Template created"
    }
    ```  
    返回创建的模板ID，名称，包含步骤数量等信息。  
  - **错误码**：  
    - 400：步骤列表格式错误（例如缺少必须字段）。  
    - 401/403：未认证或无权限创建模板（需特定权限）。  

- **获取SOP模板列表**（List SOP Templates）  
  - **请求方法**：GET  
  - **接口路径**：`/api/sop/templates`  
  - **请求参数**：可选筛选，例如`?q=关键词`按名称搜索。  
  - **返回结果**（JSON示例）：  
    ```json
    {
      "templates": [
        { "id": 5, "name": "库存检查流程", "steps_count": 3, "version": "1.0" },
        { "id": 2, "name": "新人入职流程", "steps_count": 5, "version": "2.1" }
      ]
    }
    ```  
    列出所有模板基本信息。  
  - **错误码**：无特殊错误。未授权访问则401/403。  

- **获取SOP模板详情**  
  - **请求方法**：GET  
  - **接口路径**：`/api/sop/templates/{template_id}`  
  - **返回结果**：JSON包含模板详细信息（名称、描述、全部步骤配置等）。  
  - **错误码**：404模板不存在，401/403权限问题。  

- **启动SOP流程**（Execute SOP）  
  - **请求方法**：POST  
  - **接口路径**：`/api/sop/runs`  
  - **请求参数**（JSON）：  
    - `template_id` (integer)：要执行的SOP模板ID，必填。  
    - `context` (object)：执行该流程所需的上下文参数，选填。比如流程里的某些步骤需要的初始数据，可通过context提供。  
  - **返回结果**（JSON示例）：  
    ```json
    {
      "run_id": "flow_20250315_001",
      "template_id": 5,
      "status": "running",
      "started_at": "2025-03-15T21:32:00Z"
    }
    ```  
    返回启动的流程实例ID（如`flow_年月日_编号`或UUID形式）、所基于的模板ID，以及当前状态（`running`运行中）和开始时间。流程将异步执行各步骤。  
  - **错误码**：  
    - 404：模板ID不存在。  
    - 400：缺少必要的上下文参数导致无法执行。  
    - 401/403：未授权或无权限启动该流程。  

- **查询SOP流程执行状态**（Get SOP Run Status）  
  - **请求方法**：GET  
  - **接口路径**：`/api/sop/runs/{run_id}`  
  - **路径参数**：`run_id`为流程实例ID。  
  - **返回结果**（JSON示例）：  
    ```json
    {
      "run_id": "flow_20250315_001",
      "template_id": 5,
      "status": "completed",
      "current_step": null,
      "steps": [
        { "order": 1, "name": "检查库存", "status": "success", "started_at": "2025-03-15T21:32:01Z", "ended_at": "2025-03-15T21:32:10Z" },
        { "order": 2, "name": "通知采购", "status": "success", "started_at": "2025-03-15T21:32:10Z", "ended_at": "2025-03-15T21:33:00Z" },
        { "order": 3, "name": "生成报告", "status": "success", "started_at": "2025-03-15T21:33:00Z", "ended_at": "2025-03-15T21:34:20Z" }
      ],
      "finished_at": "2025-03-15T21:34:20Z",
      "result": { "report_url": "https://minio.mycompany.com/reports/abc.pdf" }
    }
    ```  
    返回指定流程实例的详细执行状态：`status`表明整体状态（进行中`running`，已完成`completed`，失败`failed`等），`current_step`指当前正在执行的步骤（已完成则为空），`steps`数组列出每个步骤的状态和时间节点，`finished_at`结束时间，`result`为最终输出结果（如果有，例如生成的报告链接）。  
  - **错误码**：  
    - 404：流程ID不存在。  
    - 401/403：未授权或无权限查看该流程细节。  

- **取消/终止SOP流程**（Cancel SOP Run）  
  - **请求方法**：POST /api/sop/runs/{run_id}/cancel  
  - **功能**：中止一个正在执行的流程。其参数和返回与任务取消类似，略。  
  - **错误码**：404未找到流程，409无法取消（已完成），等。

以上API设计涵盖了李府管家系统的主要功能模块。在实际实现中，所有接口都需要经过OAuth2认证，非公开接口要求携带正确的Bearer Token。RBAC权限控制贯穿其中，不同角色的用户只能访问被授予权限的接口，如普通用户可能无法调用管理员工具注册接口等。错误码除了上述业务定义，还包括常见HTTP标准状态码。返回的数据格式统一为JSON，并尽可能包含必要的信息和易于解析的结构，方便前端处理和呈现。